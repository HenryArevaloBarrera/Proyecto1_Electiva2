<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle del producto</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f8;
    }
    .producto-detalle {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      align-items: start;
    }
    .producto-detalle img {
      max-width: 400px;
      border-radius: 10px;
      object-fit: cover;
    }
    .producto-info {
      flex: 1;
      min-width: 300px;
    }
    .precio {
      font-size: 1.5rem;
      color: #28a745;
      font-weight: bold;
    }
    .relacionados {
      margin-top: 3rem;
    }
    .relacionados h4 {
      font-weight: bold;
      margin-bottom: 1rem;
    }
    .producto-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      transition: transform 0.2s;
    }
    .producto-card:hover {
      transform: translateY(-5px);
    }
    .producto-card img {
      height: 200px;
      object-fit: cover;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      width: 100%;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
<%- include("templates/header", { title: "Detalle del producto" }) %>


  <!-- Contenido principal -->
  <main class="container my-5">
    <div id="producto-detalle" class="producto-detalle bg-white shadow-sm p-4 rounded">
      <p>Cargando producto...</p>
    </div>

    <!-- Secci√≥n de productos relacionados -->
    <div class="relacionados">
      <h4>üõí Productos relacionados</h4>
      <div id="relacionados-container" class="row g-3">
        <!-- Aqu√≠ se cargar√°n las sugerencias -->
      </div>
    </div>
  </main>

  <script>
    const productoId = "<%= id %>";

    async function cargarProducto() {
      try {
        const res = await fetch(`/api/productos/${productoId}`);
        const json = await res.json();
        const cont = document.getElementById("producto-detalle");

        if (!json.state) {
          cont.innerHTML = `<div class="alert alert-danger">${json.error}</div>`;
          return;
        }

        const p = json.producto;

        cont.innerHTML = `
          <img src="${p.imagen || 'https://via.placeholder.com/400'}" alt="${p.titulo}" class="img-fluid"/>
          <div class="producto-info">
            <h2>${p.titulo}</h2>
            <p class="text-muted">${p.categoria || 'Sin categor√≠a'}</p>
            <p>${p.descripcion}</p>
            <p class="precio">$${p.precio}</p>
            <hr>
            <h5>Informaci√≥n del vendedor</h5>
            <p><strong>Nombre:</strong> ${p.usuarioId?.nombre || 'N/A'}</p>
            <p><strong>Correo:</strong> ${p.usuarioId?.correo || 'N/A'}</p>
            <p><strong>Tel√©fono:</strong> ${p.usuarioId?.telefono || 'N/A'}</p>
            <a href="/" class="btn btn-outline-secondary mt-3">‚Üê Volver a la tienda</a>
          </div>
        `;

        // Luego de cargar el producto, cargamos los relacionados
        cargarRelacionados(p.categoria, p._id);

      } catch (err) {
        document.getElementById("producto-detalle").innerHTML =
          `<div class="alert alert-danger">‚ö†Ô∏è Error al cargar el producto</div>`;
      }
    }

    async function cargarRelacionados(categoria, idActual) {
      const contRel = document.getElementById("relacionados-container");

      try {
        const res = await fetch("/api/productos");
        const json = await res.json();

        if (!json.state) {
          contRel.innerHTML = `<div class="col-12 alert alert-warning">No se pudieron cargar productos relacionados.</div>`;
          return;
        }

        // Filtramos productos de la misma categor√≠a, distintos del actual
        let relacionados = json.productos.filter(p => p._id !== idActual);

        if (categoria) {
          relacionados = relacionados.filter(p => p.categoria === categoria);
        }

        // Si hay pocos, rellenamos con otros productos
        if (relacionados.length < 4) {
          const faltan = 4 - relacionados.length;
          const extra = json.productos
            .filter(p => p._id !== idActual && !relacionados.includes(p))
            .slice(0, faltan);
          relacionados = relacionados.concat(extra);
        }

        // Tomamos m√°ximo 4 sugerencias
        relacionados = relacionados.slice(0, 4);

        if (relacionados.length === 0) {
          contRel.innerHTML = `<div class="col-12 text-center text-muted">No hay productos relacionados disponibles.</div>`;
          return;
        }

        contRel.innerHTML = relacionados.map(p => `
          <div class="col-md-3">
            <div class="producto-card shadow-sm">
              <img src="${p.imagen || 'https://via.placeholder.com/300'}" alt="${p.titulo}">
              <div class="p-3">
                <h6>${p.titulo}</h6>
                <p class="text-muted small mb-1">${p.categoria || 'Sin categor√≠a'}</p>
                <p class="text-success fw-bold">$${p.precio}</p>
                <a href="/producto/${p._id}" class="btn btn-primary btn-sm w-100">Ver m√°s</a>
              </div>
            </div>
          </div>
        `).join("");

      } catch (err) {
        contRel.innerHTML = `<div class="col-12 alert alert-danger">‚ö†Ô∏è Error al cargar los productos relacionados.</div>`;
      }
    }

    cargarProducto();
  </script>
</body>
</html>
