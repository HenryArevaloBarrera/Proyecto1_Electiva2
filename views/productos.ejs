<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f8; }
    .post-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
      transition: transform 0.2s;
    }
    .post-card:hover { transform: translateY(-5px); }
    .post-card img {
      width: 100%;
      height: 300px;
      object-fit: cover;
    }
    .post-card .card-body { padding: 1rem; }
    .post-card .price {
      color: #28a745;
      font-weight: bold;
    }
    #productos-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <%- include("templates/header") %>

  <!-- Contenido -->
  <main class="container my-4">
    <div class="text-center mb-4">
      <h1 class="fw-bold">Nuestros Productos</h1>
      <p class="text-muted">Explora nuestra lista de productos disponibles</p>
    </div>

    <!-- Filtros -->
    <div class="card p-3 mb-4 shadow-sm">
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <label class="form-label fw-bold">CategorÃ­a</label>
          <select id="filtro-categoria" class="form-select">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label fw-bold">Precio mÃ¡ximo</label>
          <input type="number" id="filtro-precio" class="form-control" placeholder="Ej: 100000">
        </div>

        <div class="col-md-4 text-center">
          <button id="btn-filtrar" class="btn btn-success mt-3 w-100">Aplicar Filtros</button>
        </div>
      </div>
    </div>

    <!-- Contenedor de productos -->
    <div id="productos-container"></div>

    <!-- Loader -->
    <div id="loader" class="text-center my-4 d-none">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Cargando productos...</p>
    </div>

    <!-- Mensaje cuando no hay productos -->
    <div id="no-productos" class="alert alert-warning text-center d-none">
      ðŸš« No hay productos disponibles en este momento.
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script productos -->
  <script>
    const productosContainer = document.getElementById("productos-container");
    const loader = document.getElementById("loader");
    const noProductos = document.getElementById("no-productos");
    const filtroCategoria = document.getElementById("filtro-categoria");
    const filtroPrecio = document.getElementById("filtro-precio");
    const btnFiltrar = document.getElementById("btn-filtrar");

    let todosLosProductos = [];

    async function loadProductos() {
      loader.classList.remove("d-none");
      productosContainer.innerHTML = "";
      noProductos.classList.add("d-none");

      try {
        const res = await fetch("/api/productos");
        const json = await res.json();
        loader.classList.add("d-none");

        if (!json.state) {
          noProductos.textContent = json.error || "Error al cargar productos";
          noProductos.classList.remove("d-none");
          return;
        }

        todosLosProductos = json.productos;
        generarCategorias(todosLosProductos);
        mostrarProductos(todosLosProductos);

      } catch (err) {
        loader.classList.add("d-none");
        noProductos.textContent = "âš ï¸ Error de conexiÃ³n con el servidor.";
        noProductos.classList.remove("d-none");
      }
    }

    function generarCategorias(productos) {
      const categorias = new Set();

      productos.forEach(p => {
        if (p.categoria && p.categoria.trim() !== "") {
          categorias.add(p.categoria.trim());
        }
      });

      filtroCategoria.innerHTML = `<option value="">Todas</option>`;
      categorias.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        filtroCategoria.appendChild(option);
      });
    }

    function mostrarProductos(productos) {
      productosContainer.innerHTML = "";

      if (productos.length === 0) {
        noProductos.classList.remove("d-none");
        return;
      }

      noProductos.classList.add("d-none");

      productos.forEach(p => {
        const card = document.createElement("div");
        card.classList.add("post-card", "shadow-sm");

        card.innerHTML = `
          <img src="${p.imagen || 'https://via.placeholder.com/300'}" alt="${p.titulo}">
          <div class="card-body">
            <h5 class="card-title">${p.titulo}</h5>
            <p class="card-text">${p.descripcion}</p>
            <p class="price">Precio: $${p.precio}</p>
            <hr>
            <a href="/producto/${p._id}" class="btn btn-primary mt-2">Ver mÃ¡s</a>
          </div>
        `;
        productosContainer.appendChild(card);
      });
    }

    btnFiltrar.addEventListener("click", () => {
      const categoria = filtroCategoria.value.trim();
      const precioMax = parseFloat(filtroPrecio.value);

      const filtrados = todosLosProductos.filter(p => {
        const coincideCategoria = categoria === "" || p.categoria === categoria;
        const coincidePrecio = isNaN(precioMax) || p.precio <= precioMax;
        return coincideCategoria && coincidePrecio;
      });

      mostrarProductos(filtrados);
    });

    loadProductos();
  </script>
</body>
</html>
